version: '3.7'
services:

{% if role_regards_stack_mservices.config is defined %}
  rs-config:
    image: {{ role_regards_stack_registry }}/rs-config:{{ role_regards_stack_mservices.config.tag }}
    user: "{{ role_regards_stack_container_run_uid }}:{{ role_regards_stack_container_run_gid }}"
    hostname: rs-config
    read_only: true
{% if role_regards_stack_mservices.config.node_label_placement_constraint is defined %}
    deploy:
      placement:
        constraints:
          - node.labels.{{ role_regards_stack_mservices.config.node_label_placement_constraint.key }} == {{ role_regards_stack_mservices.config.node_label_placement_constraint.value }}
{% endif %}
    networks: 
      - {{ role_regards_stack_docker_network_name }}
{% if role_regards_stack_mservices.config.http is defined %}
    ports:
      - "{{ role_regards_stack_mservices.config.http }}:9031"
{% endif %}
    volumes:
      - {{ role_regards_stack_config }}regards/config:/config/regards:ro
      - {{ role_regards_stack_workspace_local }}regards/logs/config:/logs
      - type: tmpfs
        target: /tmp
    logging:
      options:
        max-size: "10m"
        max-file: "10"
{% endif %}

{% if role_regards_stack_mservices.registry is defined %}
  # Eureka
  rs-registry:
    image: {{ role_regards_stack_registry }}/rs-registry:{{ role_regards_stack_mservices.registry.tag }}
    user: "{{ role_regards_stack_container_run_uid }}:{{ role_regards_stack_container_run_gid }}"
    hostname: rs-registry
    read_only: true
{% if role_regards_stack_mservices.registry.node_label_placement_constraint is defined %}
    deploy:
      placement:
        constraints:
          - node.labels.{{ role_regards_stack_mservices.registry.node_label_placement_constraint.key }} == {{ role_regards_stack_mservices.registry.node_label_placement_constraint.value }}
{% endif %}
    networks:
      - {{ role_regards_stack_docker_network_name }}
    volumes:
      - {{ role_regards_stack_workspace_local }}regards/logs/registry:/logs
      - type: tmpfs
        target: /tmp
{% if role_regards_stack_mservices.registry.http is defined or role_regards_stack_mservices.registry.jdwp is defined or role_regards_stack_mservices.registry.jmx is defined or role_regards_stack_mservices.registry.yourkit is defined %}
    ports:
{% if role_regards_stack_mservices.registry.http is defined %}
      - "{{ role_regards_stack_mservices.registry.http }}:9032"
{% endif %}
{% if role_regards_stack_mservices.registry.jdwp is defined %}
      - "{{ role_regards_stack_mservices.registry.jdwp }}:10500"
{% endif %}
{% if role_regards_stack_mservices.registry.jmx is defined %}
      - "{{ role_regards_stack_mservices.registry.jmx }}:19032"
{% endif %}
{% if role_regards_stack_mservices.registry.yourkit is defined %}
      - "{{ role_regards_stack_mservices.registry.yourkit }}:10001"
{% endif %}
{% endif %}
    logging:
      options:
        max-size: "10m"
        max-file: "10"
{% endif %}

{% if role_regards_stack_mservices.gateway is defined %}
  # Zuul
  rs-gateway:
    image: {{ role_regards_stack_registry }}/rs-gateway:{{ role_regards_stack_mservices.gateway.tag }}
    user: "{{ role_regards_stack_container_run_uid }}:{{ role_regards_stack_container_run_gid }}"
    hostname: rs-gateway
    read_only: true
    deploy:
      replicas: {{ role_regards_stack_mservices.gateway.replicas | default(1) }}
{% if role_regards_stack_mservices.gateway.node_label_placement_constraint is defined %}
      placement:
        constraints:
          - node.labels.{{ role_regards_stack_mservices.gateway.node_label_placement_constraint.key }} == {{ role_regards_stack_mservices.gateway.node_label_placement_constraint.value }}
{% endif %}
{% if role_regards_stack_mservices.gateway.jdwp is defined %}
    environment: 
      - ACTIVE_DEBUG=true
{% endif %}
{% if role_regards_stack_mservices.gateway.yourkit is defined %}
      - ACTIVE_YOURKIT=true
{% endif %}
    networks:
      - {{ role_regards_stack_docker_network_name }}
    volumes:
      - {{ role_regards_stack_logback }}gateway:/config:ro
      - {{ role_regards_stack_workspace_local }}regards/logs/gateway:/logs
      - type: tmpfs
        target: /tmp
{% if role_regards_stack_mservices.gateway.http is defined or role_regards_stack_mservices.gateway.jdwp is defined or role_regards_stack_mservices.gateway.jmx is defined or role_regards_stack_mservices.gateway.yourkit is defined %}
    ports:
{% if role_regards_stack_mservices.gateway.http is defined %}
      - "{{ role_regards_stack_mservices.gateway.http }}:9030"
{% endif %}
{% if role_regards_stack_mservices.gateway.jdwp is defined %}
      - "{{ role_regards_stack_mservices.gateway.jdwp }}:10500"
{% endif %}
{% if role_regards_stack_mservices.gateway.jmx is defined %}
      - "{{ role_regards_stack_mservices.gateway.jmx }}:18030"
{% endif %}
{% if role_regards_stack_mservices.gateway.yourkit is defined %}
      - "{{ role_regards_stack_mservices.gateway.yourkit }}:10001"
{% endif %}
{% endif %}
    logging:
      options:
        max-size: "10m"
        max-file: "10"
{% endif %}

{% if role_regards_stack_mservices.admin_instance is defined %}
  rs-admin-instance:
    image: {{ role_regards_stack_registry }}/{{ role_regards_stack_mservices_admin_instance_image_name }}:{{ role_regards_stack_mservices.admin_instance.tag }}
    user: "{{ role_regards_stack_container_run_uid }}:{{ role_regards_stack_container_run_gid }}"
    hostname: rs-admin-instance
    read_only: true
{% if role_regards_stack_mservices.admin_instance.node_label_placement_constraint is defined %}
    deploy:
      placement:
        constraints:
          - node.labels.{{ role_regards_stack_mservices.admin_instance.node_label_placement_constraint.key }} == {{ role_regards_stack_mservices.admin_instance.node_label_placement_constraint.value }}
{% endif %}
    networks:
      - {{ role_regards_stack_docker_network_name }}
{% if role_regards_stack_mservices.admin_instance.jdwp is defined %}
    environment: 
      - ACTIVE_DEBUG=true
{% endif %}
{% if role_regards_stack_mservices.admin_instance.yourkit is defined %}
      - ACTIVE_YOURKIT=true
{% endif %}
    volumes:
      - {{ role_regards_stack_logback }}admin-instance:/config:ro
      - {{ role_regards_stack_workspace_local }}regards/logs/admin-instance:/logs
      - type: tmpfs
        target: /tmp
{% if role_regards_stack_mservices.admin_instance.http is defined or role_regards_stack_mservices.admin_instance.jdwp is defined or role_regards_stack_mservices.admin_instance.jmx is defined or role_regards_stack_mservices.admin_instance.yourkit is defined %}
    ports:
{% if role_regards_stack_mservices.admin_instance.http is defined %}
      - "{{ role_regards_stack_mservices.admin_instance.http }}:9037"
{% endif %}
{% if role_regards_stack_mservices.admin_instance.jdwp is defined %}
      - "{{ role_regards_stack_mservices.admin_instance.jdwp }}:10500"
{% endif %}
{% if role_regards_stack_mservices.admin_instance.jmx is defined %}
      - "{{ role_regards_stack_mservices.admin_instance.jmx }}:18037"
{% endif %}
{% if role_regards_stack_mservices.admin_instance.yourkit is defined %}
      - "{{ role_regards_stack_mservices.admin_instance.yourkit }}:10001"
{% endif %}
{% endif %}
    logging:
      options:
        max-size: "10m"
        max-file: "10"
{% endif %}

{% if role_regards_stack_mservices.admin is defined %}
  rs-admin:
    image: {{ role_regards_stack_registry }}/{{ role_regards_stack_mservices_admin_image_name  }}:{{ role_regards_stack_mservices.admin.tag }}
    user: "{{ role_regards_stack_container_run_uid }}:{{ role_regards_stack_container_run_gid }}"
    hostname: rs-admin
    read_only: true
    deploy:
      replicas: {{ role_regards_stack_mservices.admin.replicas | default(1) }}
{% if role_regards_stack_mservices.admin.node_label_placement_constraint is defined %}
      placement:
        constraints:
          - node.labels.{{ role_regards_stack_mservices.admin.node_label_placement_constraint.key }} == {{ role_regards_stack_mservices.admin.node_label_placement_constraint.value }}
{% endif %}
{% if role_regards_stack_mservices.admin.jdwp is defined %}
    environment: 
      - ACTIVE_DEBUG=true
{% endif %}
{% if role_regards_stack_mservices.admin.yourkit is defined %}
      - ACTIVE_YOURKIT=true
{% endif %}
    networks:
      - {{ role_regards_stack_docker_network_name }}
    volumes:
      - {{ role_regards_stack_logback }}admin:/config:ro
      - {{ role_regards_stack_workspace_local }}regards/logs/admin:/logs
      - type: tmpfs
        target: /tmp
{% if role_regards_stack_mservices.admin.http is defined or role_regards_stack_mservices.admin.jdwp is defined or role_regards_stack_mservices.admin.jmx is defined or role_regards_stack_mservices.admin.yourkit is defined %}
    ports:
{% if role_regards_stack_mservices.admin.http is defined %}
      - "{{ role_regards_stack_mservices.admin.http }}:9033"
{% endif %}
{% if role_regards_stack_mservices.admin.jdwp is defined %}
      - "{{ role_regards_stack_mservices.admin.jdwp }}:10500"
{% endif %}
{% if role_regards_stack_mservices.admin.jmx is defined %}
      - "{{ role_regards_stack_mservices.admin.jmx }}:18033"
{% endif %}
{% if role_regards_stack_mservices.admin.yourkit is defined %}
      - "{{ role_regards_stack_mservices.admin.yourkit }}:10001"
{% endif %}
{% endif %}
    logging:
      options:
        max-size: "10m"
        max-file: "10"
{% endif %}

{% if role_regards_stack_mservices.authentication is defined %}
  rs-authentication:
    image: {{ role_regards_stack_registry }}/rs-authentication:{{ role_regards_stack_mservices.authentication.tag }}
    user: "{{ role_regards_stack_container_run_uid }}:{{ role_regards_stack_container_run_gid }}"
    hostname: rs-authentication
    read_only: true
    deploy:
      replicas: {{ role_regards_stack_mservices.authentication.replicas | default(1) }}
{% if role_regards_stack_mservices.authentication.node_label_placement_constraint is defined %}
      placement:
        constraints:
          - node.labels.{{ role_regards_stack_mservices.authentication.node_label_placement_constraint.key }} == {{ role_regards_stack_mservices.authentication.node_label_placement_constraint.value }}
{% endif %}
{% if role_regards_stack_mservices.authentication.jdwp is defined %}
    environment: 
      - ACTIVE_DEBUG=true
{% endif %}
{% if role_regards_stack_mservices.authentication.yourkit is defined %}
      - ACTIVE_YOURKIT=true
{% endif %}
    networks:
      - {{ role_regards_stack_docker_network_name }}
    volumes:
      - {{ role_regards_stack_workspace_local }}regards/plugins/authentication:/plugins:ro
      - {{ role_regards_stack_workspace_local }}regards/logs/authentication:/logs
      - {{ role_regards_stack_logback }}authentication:/config:ro
      - type: tmpfs
        target: /tmp
{% if role_regards_stack_mservices.authentication.http is defined or role_regards_stack_mservices.authentication.jdwp is defined or role_regards_stack_mservices.authentication.jmx is defined or role_regards_stack_mservices.authentication.yourkit is defined %}
    ports:
{% if role_regards_stack_mservices.authentication.http is defined %}
      - "{{ role_regards_stack_mservices.authentication.http }}:9034"
{% endif %}
{% if role_regards_stack_mservices.authentication.jdwp is defined %}
      - "{{ role_regards_stack_mservices.authentication.jdwp }}:10500"
{% endif %}
{% if role_regards_stack_mservices.authentication.jmx is defined %}
      - "{{ role_regards_stack_mservices.authentication.jmx }}:18034"
{% endif %}
{% if role_regards_stack_mservices.authentication.yourkit is defined %}
      - "{{ role_regards_stack_mservices.authentication.yourkit }}:10001"
{% endif %}
{% endif %}
    logging:
      options:
        max-size: "10m"
        max-file: "10"
{% endif %}

{% if role_regards_stack_mservices.dam is defined %}
  rs-dam:
    image: {{ role_regards_stack_registry }}/rs-dam:{{ role_regards_stack_mservices.dam.tag }}
    user: "{{ role_regards_stack_container_run_uid }}:{{ role_regards_stack_container_run_gid }}"
    hostname: rs-dam
    read_only: true
    deploy:
      replicas: {{ role_regards_stack_mservices.dam.replicas | default(1) }}
{% if role_regards_stack_mservices.dam.node_label_placement_constraint is defined %}
      placement:
        constraints:
          - node.labels.{{ role_regards_stack_mservices.dam.node_label_placement_constraint.key }} == {{ role_regards_stack_mservices.dam.node_label_placement_constraint.value }}
{% endif %}
    networks:
      - {{ role_regards_stack_docker_network_name }}
{% if role_regards_stack_mservices.dam.jdwp is defined %}
    environment: 
      - ACTIVE_DEBUG=true
{% endif %}
{% if role_regards_stack_mservices.dam.yourkit is defined %}
      - ACTIVE_YOURKIT=true
{% endif %}
    volumes:
{% if role_regards_stack_mservices.dam.volumes is defined %}
{% for volume in role_regards_stack_mservices.dam.volumes %}
      - {{ volume.source }}:{{ volume.destination }}
{% endfor %}
{% endif %}
      - {{ role_regards_stack_logback }}dam:/config:ro
      - {{ role_regards_stack_workspace_local }}regards/plugins/dam:/plugins:ro
      - {{ role_regards_stack_workspace_local }}regards/logs/dam:/logs
      - {{ role_regards_stack_workspace_network }}regards/storage/dam:/storage
      - {{ role_regards_stack_workspace_network }}regards/workspace:/tmp/workspace
      - type: tmpfs
        target: /tmp
{% if role_regards_stack_mservices.dam.http is defined or role_regards_stack_mservices.dam.jdwp is defined or role_regards_stack_mservices.dam.jmx is defined or role_regards_stack_mservices.dam.yourkit is defined %}
    ports:
{% if role_regards_stack_mservices.dam.http is defined %}
      - "{{ role_regards_stack_mservices.dam.http }}:9035"
{% endif %}
{% if role_regards_stack_mservices.dam.jdwp is defined %}
      - "{{ role_regards_stack_mservices.dam.jdwp }}:10500"
{% endif %}
{% if role_regards_stack_mservices.dam.jmx is defined %}
      - "{{ role_regards_stack_mservices.dam.jmx }}:18035"
{% endif %}
{% if role_regards_stack_mservices.dam.yourkit is defined %}
      - "{{ role_regards_stack_mservices.dam.yourkit }}:10001"
{% endif %}
{% endif %}
    logging:
      options:
        max-size: "10m"
        max-file: "10"
{% endif %}

{% if role_regards_stack_mservices.notifier is defined %}
  rs-notifier:
    image: {{ role_regards_stack_registry }}/rs-notifier:{{ role_regards_stack_mservices.notifier.tag }}
    user: "{{ role_regards_stack_container_run_uid }}:{{ role_regards_stack_container_run_gid }}"
    hostname: rs-notifier
    read_only: true
    deploy:
      replicas: {{ role_regards_stack_mservices.notifier.replicas | default(1) }}
{% if role_regards_stack_mservices.notifier.node_label_placement_constraint is defined %}
      placement:
        constraints:
          - node.labels.{{ role_regards_stack_mservices.notifier.node_label_placement_constraint.key }} == {{ role_regards_stack_mservices.notifier.node_label_placement_constraint.value }}
{% endif %}
    networks:
      - {{ role_regards_stack_docker_network_name }}
{% if role_regards_stack_mservices.notifier.jdwp is defined %}
    environment: 
      - ACTIVE_DEBUG=true
{% endif %}
{% if role_regards_stack_mservices.notifier.yourkit is defined %}
      - ACTIVE_YOURKIT=true
{% endif %}
    volumes:
      - {{ role_regards_stack_logback }}notifier:/config:ro
      - {{ role_regards_stack_workspace_local }}regards/logs/notifier:/logs
      - {{ role_regards_stack_workspace_local }}regards/plugins/notifier:/plugins
      - type: tmpfs
        target: /tmp
{% if role_regards_stack_mservices.notifier.http is defined or role_regards_stack_mservices.notifier.jdwp is defined or role_regards_stack_mservices.notifier.jmx is defined or role_regards_stack_mservices.notifier.yourkit is defined %}
    ports:
{% if role_regards_stack_mservices.notifier.http is defined %}
      - "{{ role_regards_stack_mservices.notifier.http }}:9039"
{% endif %}
{% if role_regards_stack_mservices.notifier.jdwp is defined %}
      - "{{ role_regards_stack_mservices.notifier.jdwp }}:10500"
{% endif %}
{% if role_regards_stack_mservices.notifier.jmx is defined %}
      - "{{ role_regards_stack_mservices.notifier.jmx }}:18039"
{% endif %}
{% if role_regards_stack_mservices.notifier.yourkit is defined %}
      - "{{ role_regards_stack_mservices.notifier.yourkit }}:10001"
{% endif %}
{% endif %}
    logging:
      options:
        max-size: "10m"
        max-file: "10"
{% endif %}

{% if role_regards_stack_mservices.fem is defined %}
  rs-fem:
    image: {{ role_regards_stack_registry }}/rs-fem:{{ role_regards_stack_mservices.fem.tag }}
    user: "{{ role_regards_stack_container_run_uid }}:{{ role_regards_stack_container_run_gid }}"
    hostname: rs-fem
    read_only: true
    deploy:
      replicas: {{ role_regards_stack_mservices.fem.replicas | default(1) }}
{% if role_regards_stack_mservices.fem.node_label_placement_constraint is defined %}
      placement:
        constraints:
          - node.labels.{{ role_regards_stack_mservices.fem.node_label_placement_constraint.key }} == {{ role_regards_stack_mservices.fem.node_label_placement_constraint.value }}
{% endif %}
    networks:
      - {{ role_regards_stack_docker_network_name }}
{% if role_regards_stack_mservices.fem.jdwp is defined %}
    environment: 
      - ACTIVE_DEBUG=true
{% endif %}
{% if role_regards_stack_mservices.fem.yourkit is defined %}
      - ACTIVE_YOURKIT=true
{% endif %}
    volumes:
{% if role_regards_stack_mservices.fem.volumes is defined %}
{% for volume in role_regards_stack_mservices.fem.volumes %}
      - {{ volume.source }}:{{ volume.destination }}
{% endfor %}
{% endif %}
      - {{ role_regards_stack_logback }}fem:/config:ro
      - {{ role_regards_stack_workspace_local }}regards/logs/fem:/logs
      - {{ role_regards_stack_workspace_local }}regards/plugins/fem:/plugins:ro
      - {{ role_regards_stack_workspace_network }}regards/workspace:/tmp/workspace
      - {{ role_regards_stack_workspace_network }}regards/input:/input
      - type: tmpfs
        target: /tmp
{% if role_regards_stack_mservices.fem.http is defined or role_regards_stack_mservices.fem.jdwp is defined or role_regards_stack_mservices.fem.jmx is defined or role_regards_stack_mservices.fem.yourkit is defined %}
    ports:
{% if role_regards_stack_mservices.fem.http is defined %}
      - "{{ role_regards_stack_mservices.fem.http }}:9035"
{% endif %}
{% if role_regards_stack_mservices.fem.jdwp is defined %}
      - "{{ role_regards_stack_mservices.fem.jdwp }}:10500"
{% endif %}
{% if role_regards_stack_mservices.fem.jmx is defined %}
      - "{{ role_regards_stack_mservices.fem.jmx }}:18038"
{% endif %}
{% if role_regards_stack_mservices.fem.yourkit is defined %}
      - "{{ role_regards_stack_mservices.fem.yourkit }}:10001"
{% endif %}
{% endif %}
    logging:
      options:
        max-size: "10m"
        max-file: "10"
{% endif %}

{% if role_regards_stack_mservices.catalog is defined %}
  rs-catalog:
    image: {{ role_regards_stack_registry }}/rs-catalog:{{ role_regards_stack_mservices.catalog.tag }}
    user: "{{ role_regards_stack_container_run_uid }}:{{ role_regards_stack_container_run_gid }}"
    hostname: rs-catalog
    read_only: true
    deploy:
      replicas: {{ role_regards_stack_mservices.catalog.replicas | default(1) }}
{% if role_regards_stack_mservices.catalog.node_label_placement_constraint is defined %}
      placement:
        constraints:
          - node.labels.{{ role_regards_stack_mservices.catalog.node_label_placement_constraint.key }} == {{ role_regards_stack_mservices.catalog.node_label_placement_constraint.value }}
{% endif %}
    networks:
      - {{ role_regards_stack_docker_network_name }}
{% if role_regards_stack_mservices.catalog.jdwp is defined %}
    environment: 
      - ACTIVE_DEBUG=true
{% endif %}
{% if role_regards_stack_mservices.catalog.yourkit is defined %}
      - ACTIVE_YOURKIT=true
{% endif %}
    volumes:
      - {{ role_regards_stack_logback }}catalog:/config:ro
      - {{ role_regards_stack_workspace_local }}regards/logs/catalog:/logs
      - {{ role_regards_stack_workspace_local }}regards/plugins/catalog:/plugins:ro
      - {{ role_regards_stack_workspace_network }}regards/workspace:/tmp/workspace
      - type: tmpfs
        target: /tmp
{% if role_regards_stack_mservices.catalog.http is defined or role_regards_stack_mservices.catalog.jdwp is defined or role_regards_stack_mservices.catalog.jmx is defined or role_regards_stack_mservices.catalog.yourkit is defined %}
    ports:
{% if role_regards_stack_mservices.catalog.http is defined %}
      - "{{ role_regards_stack_mservices.catalog.http }}:9036"
{% endif %}
{% if role_regards_stack_mservices.catalog.jdwp is defined %}
      - "{{ role_regards_stack_mservices.catalog.jdwp }}:10500"
{% endif %}
{% if role_regards_stack_mservices.catalog.jmx is defined %}
      - "{{ role_regards_stack_mservices.catalog.jmx }}:18036"
{% endif %}
{% if role_regards_stack_mservices.catalog.yourkit is defined %}
      - "{{ role_regards_stack_mservices.catalog.yourkit }}:10001"
{% endif %}
{% endif %}
    logging:
      options:
        max-size: "10m"
        max-file: "10"
{% endif %}

{% if role_regards_stack_mservices.access_instance is defined %}
  rs-access-instance:
    image: {{ role_regards_stack_registry }}/{{ role_regards_stack_mservices_access_instance_image_name }}:{{ role_regards_stack_mservices.access_instance.tag }}
    user: "{{ role_regards_stack_container_run_uid }}:{{ role_regards_stack_container_run_gid }}"
    hostname: rs-access-instance
    read_only: true
{% if role_regards_stack_mservices.access_instance.node_label_placement_constraint is defined %}
    deploy:
      placement:
        constraints:
          - node.labels.{{ role_regards_stack_mservices.access_instance.node_label_placement_constraint.key }} == {{ role_regards_stack_mservices.access_instance.node_label_placement_constraint.value }}
{% endif %}
    networks:
      - {{ role_regards_stack_docker_network_name }}
{% if role_regards_stack_mservices.access_instance.jdwp is defined %}
    environment: 
      - ACTIVE_DEBUG=true
{% endif %}
{% if role_regards_stack_mservices.access_instance.yourkit is defined %}
      - ACTIVE_YOURKIT=true
{% endif %}
    volumes:
      - {{ role_regards_stack_logback }}access-instance:/config:ro
      - {{ role_regards_stack_workspace_local }}regards/logs/access-instance:/logs
      - type: tmpfs
        target: /tmp
{% if role_regards_stack_mservices.access_instance.http is defined or role_regards_stack_mservices.access_instance.jdwp is defined or role_regards_stack_mservices.access_instance.jmx is defined or role_regards_stack_mservices.access_instance.yourkit is defined %}
    ports:
{% if role_regards_stack_mservices.access_instance.http is defined %}
      - "{{ role_regards_stack_mservices.access_instance.http }}:9040"
{% endif %}
{% if role_regards_stack_mservices.access_instance.jdwp is defined %}
      - "{{ role_regards_stack_mservices.access_instance.jdwp }}:10500"
{% endif %}
{% if role_regards_stack_mservices.access_instance.jmx is defined %}
      - "{{ role_regards_stack_mservices.access_instance.jmx }}:18040"
{% endif %}
{% if role_regards_stack_mservices.access_instance.yourkit is defined %}
      - "{{ role_regards_stack_mservices.access_instance.yourkit }}:10001"
{% endif %}
{% endif %}
    logging:
      options:
        max-size: "10m"
        max-file: "10"
{% endif %}

{% if role_regards_stack_mservices.access_project is defined %}
  rs-access-project:
    image: {{ role_regards_stack_registry }}/rs-access-project:{{ role_regards_stack_mservices.access_project.tag }}
    user: "{{ role_regards_stack_container_run_uid }}:{{ role_regards_stack_container_run_gid }}"
    hostname: rs-access-project
    read_only: true
    deploy:
      replicas: {{ role_regards_stack_mservices.access_project.replicas | default(1) }}
{% if role_regards_stack_mservices.access_project.node_label_placement_constraint is defined %}
      placement:
        constraints:
          - node.labels.{{ role_regards_stack_mservices.access_project.node_label_placement_constraint.key }} == {{ role_regards_stack_mservices.access_project.node_label_placement_constraint.value }}
{% endif %}
{% if role_regards_stack_mservices.access_project.jdwp is defined %}
    environment: 
      - ACTIVE_DEBUG=true
{% endif %}
{% if role_regards_stack_mservices.access_project.yourkit is defined %}
      - ACTIVE_YOURKIT=true
{% endif %}
    volumes:
      - {{ role_regards_stack_logback }}access-project:/config:ro
      - {{ role_regards_stack_workspace_local }}regards/logs/access-project:/logs
      - type: tmpfs
        target: /tmp
    networks:
      - {{ role_regards_stack_docker_network_name }}
{% if role_regards_stack_mservices.access_project.http is defined or role_regards_stack_mservices.access_project.jdwp is defined or role_regards_stack_mservices.access_project.jmx is defined or role_regards_stack_mservices.access_project.yourkit is defined %}
    ports:
{% if role_regards_stack_mservices.access_project.http is defined %}
      - "{{ role_regards_stack_mservices.access_project.http }}:9041"
{% endif %}
{% if role_regards_stack_mservices.access_project.jdwp is defined %}
      - "{{ role_regards_stack_mservices.access_project.jdwp }}:10500"
{% endif %}
{% if role_regards_stack_mservices.access_project.jmx is defined %}
      - "{{ role_regards_stack_mservices.access_project.jmx }}:18041"
{% endif %}
{% if role_regards_stack_mservices.access_project.yourkit is defined %}
      - "{{ role_regards_stack_mservices.access_project.yourkit }}:10001"
{% endif %}
{% endif %}
    logging: 
      options:
        max-size: "10m"
        max-file: "10"
{% endif %}

{% if role_regards_stack_mservices.front is defined %}
  rs-front:
    image: {{ role_regards_stack_registry }}/rs-front:{{ role_regards_stack_mservices.front.tag }}
    user: "{{ role_regards_stack_container_run_uid }}:{{ role_regards_stack_container_run_gid }}"
    hostname: rs-front
    read_only: true
    deploy:
      replicas: {{ role_regards_stack_mservices.front.replicas | default(1) }}
{% if role_regards_stack_mservices.front.node_label_placement_constraint is defined %}
      placement:
        constraints:
          - node.labels.{{ role_regards_stack_mservices.front.node_label_placement_constraint.key }} == {{ role_regards_stack_mservices.front.node_label_placement_constraint.value }}
{% endif %}
    networks:
      - {{ role_regards_stack_docker_network_name }}
    environment:
      - GATEWAY_PUBLIC_URL={{ role_regards_stack_public_url }}
{% if role_regards_stack_mservices.front.port is defined %}
    ports:
      - "{{ role_regards_stack_mservices.front.port }}:8080"
{% endif %}
    volumes:
      - "{{ role_regards_stack_workspace_network }}regards/front:/var/www/public/:ro"
      - "{{ role_regards_stack_workspace_local }}regards/logs/front:/var/log/nginx"
      - "{{ role_regards_stack_config }}regards/nginx/nginx.conf:/etc/nginx/nginx.conf:ro"
      - type: tmpfs
        target: /var/cache/nginx
      - type: tmpfs
        target: /tmp
      - type: tmpfs
        target: /var/www/conf
    logging:
      options:
        max-size: "10m"
        max-file: "10"
{% endif %}

{% if role_regards_stack_mservices.storage is defined %}
  rs-storage:
    image: {{ role_regards_stack_registry }}/rs-storage:{{ role_regards_stack_mservices.storage.tag }}
    user: "{{ role_regards_stack_container_run_uid }}:{{ role_regards_stack_container_run_gid }}"
    hostname: rs-storage
    read_only: true
    deploy:
      replicas: {{ role_regards_stack_mservices.storage.replicas | default(1) }}
{% if role_regards_stack_mservices.storage.node_label_placement_constraint is defined %}
      placement:
        constraints:
          - node.labels.{{ role_regards_stack_mservices.storage.node_label_placement_constraint.key }} == {{ role_regards_stack_mservices.storage.node_label_placement_constraint.value }}
{% endif %}
    networks:
      - {{ role_regards_stack_docker_network_name }}
{% if role_regards_stack_mservices.storage.jdwp is defined %}
    environment: 
      - ACTIVE_DEBUG=true
{% endif %}
{% if role_regards_stack_mservices.storage.yourkit is defined %}
      - ACTIVE_YOURKIT=true
{% endif %}
{% if role_regards_stack_mservices.storage.http is defined or role_regards_stack_mservices.storage.jdwp is defined or role_regards_stack_mservices.storage.jmx is defined or role_regards_stack_mservices.storage.yourkit is defined %}
    ports:
{% if role_regards_stack_mservices.storage.http is defined %}
      - "{{ role_regards_stack_mservices.storage.http }}:9042"
{% endif %}
{% if role_regards_stack_mservices.storage.jdwp is defined %}
      - "{{ role_regards_stack_mservices.storage.jdwp }}:10500"
{% endif %}
{% if role_regards_stack_mservices.storage.jmx is defined %}
      - "{{ role_regards_stack_mservices.storage.jmx }}:18042"
{% endif %}
{% if role_regards_stack_mservices.storage.yourkit is defined %}
      - "{{ role_regards_stack_mservices.storage.yourkit }}:10001"
{% endif %}
{% endif %}
    volumes:
{% if role_regards_stack_mservices.storage.volumes is defined %}
{% for volume in role_regards_stack_mservices.storage.volumes %}
      - {{ volume.source }}:{{ volume.destination }}
{% endfor %}
{% endif %}
      - {{ role_regards_stack_logback }}storage:/config
      - {{ role_regards_stack_workspace_local }}regards/logs/storage:/logs
      - {{ role_regards_stack_workspace_local }}regards/plugins/storage:/plugins
      - {{ role_regards_stack_workspace_network }}regards/storage/onlines:/storages
      - {{ role_regards_stack_workspace_network }}regards/storage/cache:/cache
      - {{ role_regards_stack_workspace_network }}regards/input:/input
      - {{ role_regards_stack_workspace_network }}regards/workspace:/tmp/workspace
      - type: tmpfs
        target: /tmp
    logging:
      options:
        max-size: "10m"
        max-file: "10"
{% endif %}

{% if role_regards_stack_mservices.order is defined %}
  rs-order:
    image: {{ role_regards_stack_registry }}/rs-order:{{ role_regards_stack_mservices.order.tag }}
    user: "{{ role_regards_stack_container_run_uid }}:{{ role_regards_stack_container_run_gid }}"
    hostname: rs-order
    read_only: true
    deploy:
      replicas: {{ role_regards_stack_mservices.order.replicas | default(1) }}
{% if role_regards_stack_mservices.order.node_label_placement_constraint is defined %}
      placement:
        constraints:
          - node.labels.{{ role_regards_stack_mservices.order.node_label_placement_constraint.key }} == {{ role_regards_stack_mservices.order.node_label_placement_constraint.value }}
{% endif %}
    networks:
      - {{ role_regards_stack_docker_network_name }}
{% if role_regards_stack_mservices.order.jdwp is defined %}
    environment: 
      - ACTIVE_DEBUG=true
{% endif %}
{% if role_regards_stack_mservices.order.yourkit is defined %}
      - ACTIVE_YOURKIT=true
{% endif %}
{% if role_regards_stack_mservices.order.http is defined or role_regards_stack_mservices.order.jdwp is defined or role_regards_stack_mservices.order.jmx is defined or role_regards_stack_mservices.order.yourkit is defined %}
    ports:
{% if role_regards_stack_mservices.order.http is defined %}
      - "{{ role_regards_stack_mservices.order.http }}:9043"
{% endif %}
{% if role_regards_stack_mservices.order.jdwp is defined %}
      - "{{ role_regards_stack_mservices.order.jdwp }}:10500"
{% endif %}
{% if role_regards_stack_mservices.order.jmx is defined %}
      - "{{ role_regards_stack_mservices.order.jmx }}:18043"
{% endif %}
{% if role_regards_stack_mservices.order.yourkit is defined %}
      - "{{ role_regards_stack_mservices.order.yourkit }}:10001"
{% endif %}
{% endif %}
    volumes:
{% if role_regards_stack_mservices.order.volumes is defined %}
{% for volume in role_regards_stack_mservices.order.volumes %}
      - {{ volume.source }}:{{ volume.destination }}
{% endfor %}
{% endif %}
      - {{ role_regards_stack_logback }}order:/config:ro
      - {{ role_regards_stack_workspace_local }}regards/logs/order:/logs
      - {{ role_regards_stack_workspace_network }}regards/workspace:/tmp/workspace
      - {{ role_regards_stack_workspace_network }}regards/processing:/processing
{% if role_regards_stack_mservices.order.yourkit is defined %}
      - {{ role_regards_stack_workspace_local }}regards/yourkitSnap:/?/Snapshots
{% endif %}
      - type: tmpfs
        target: /tmp
    logging:
      options:
        max-size: "10m"
        max-file: "10"
{% endif %}

{% if role_regards_stack_mservices.processing is defined %}
  rs-processing:
    image: {{ role_regards_stack_registry }}/rs-processing:{{ role_regards_stack_mservices.processing.tag }}
    user: "{{ role_regards_stack_container_run_uid }}:{{ role_regards_stack_container_run_gid }}"
    hostname: rs-processing
    read_only: true
    deploy:
      replicas: {{ role_regards_stack_mservices.processing.replicas | default(1) }}
{% if role_regards_stack_mservices.processing.node_label_placement_constraint is defined %}
      placement:
        constraints:
          - node.labels.{{ role_regards_stack_mservices.processing.node_label_placement_constraint.key }} == {{ role_regards_stack_mservices.processing.node_label_placement_constraint.value }}
{% endif %}
    networks:
      - {{ role_regards_stack_docker_network_name }}
{% if role_regards_stack_mservices.processing.jdwp is defined %}
    environment:
      - ACTIVE_DEBUG=true
      # as /tmp is mounted as noexec into docker containers we configure specific tmp directory for jna lib
      - JAVA_TOOL_OPTIONS="-Djna.tmpdir=/processing/jna-tmp"
{% endif %}
{% if role_regards_stack_mservices.processing.yourkit is defined %}
      - ACTIVE_YOURKIT=true
{% endif %}
{% if role_regards_stack_mservices.processing.http is defined or role_regards_stack_mservices.processing.jdwp is defined or role_regards_stack_mservices.processing.jmx is defined or role_regards_stack_mservices.processing.yourkit is defined %}
    ports:
{% if role_regards_stack_mservices.processing.http is defined %}
      - "{{ role_regards_stack_mservices.processing.http }}:9046"
{% endif %}
{% if role_regards_stack_mservices.processing.jdwp is defined %}
      - "{{ role_regards_stack_mservices.processing.jdwp }}:10500"
{% endif %}
{% if role_regards_stack_mservices.processing.jmx is defined %}
      - "{{ role_regards_stack_mservices.processing.jmx }}:18043"
{% endif %}
{% if role_regards_stack_mservices.processing.yourkit is defined %}
      - "{{ role_regards_stack_mservices.processing.yourkit }}:10001"
{% endif %}
{% endif %}
    volumes:
{% if role_regards_stack_mservices.processing.volumes is defined %}
{% for volume in role_regards_stack_mservices.processing.volumes %}
      - {{ volume.source }}:{{ volume.destination }}
{% endfor %}
{% endif %}
      - {{ role_regards_stack_logback }}processing:/config:ro
      - {{ role_regards_stack_workspace_local }}regards/logs/processing:/logs
      - {{ role_regards_stack_workspace_local }}regards/plugins/processing:/plugins
      - {{ role_regards_stack_workspace_network }}regards/processing:/processing
      - {{ role_regards_stack_workspace_network }}regards/input:/input
      - type: tmpfs
        target: /tmp
    logging:
      options:
        max-size: "10m"
        max-file: "10"
{% endif %}

{% if role_regards_stack_mservices.ingest is defined %}
  rs-ingest:
    image: {{ role_regards_stack_registry }}/rs-ingest:{{ role_regards_stack_mservices.ingest.tag }}
    user: "{{ role_regards_stack_container_run_uid }}:{{ role_regards_stack_container_run_gid }}"
    hostname: rs-ingest
    read_only: true
    deploy:
      replicas: {{ role_regards_stack_mservices.ingest.replicas | default(1) }}
{% if role_regards_stack_mservices.ingest.node_label_placement_constraint is defined %}
      placement:
        constraints:
          - node.labels.{{ role_regards_stack_mservices.ingest.node_label_placement_constraint.key }} == {{ role_regards_stack_mservices.ingest.node_label_placement_constraint.value }}
{% endif %}
    networks:
      - {{ role_regards_stack_docker_network_name }}
{% if role_regards_stack_mservices.ingest.jdwp is defined %}
    environment: 
      - ACTIVE_DEBUG=true
{% endif %}
{% if role_regards_stack_mservices.ingest.yourkit is defined %}
      - ACTIVE_YOURKIT=true
{% endif %}
{% if role_regards_stack_mservices.ingest.http is defined or role_regards_stack_mservices.ingest.jdwp is defined or role_regards_stack_mservices.ingest.jmx is defined or role_regards_stack_mservices.ingest.yourkit is defined %}
    ports:
{% if role_regards_stack_mservices.ingest.http is defined %}
      - "{{ role_regards_stack_mservices.ingest.http }}:9044"
{% endif %}
{% if role_regards_stack_mservices.ingest.jdwp is defined %}
      - "{{ role_regards_stack_mservices.ingest.jdwp }}:10500"
{% endif %}
{% if role_regards_stack_mservices.ingest.jmx is defined %}
      - "{{ role_regards_stack_mservices.ingest.jmx }}:18044"
{% endif %}
{% if role_regards_stack_mservices.ingest.yourkit is defined %}
      - "{{ role_regards_stack_mservices.ingest.yourkit }}:10001"
{% endif %}
{% endif %}
    volumes:
{% if role_regards_stack_mservices.ingest.volumes is defined %}
{% for volume in role_regards_stack_mservices.ingest.volumes %}
      - {{ volume.source }}:{{ volume.destination }}
{% endfor %}
{% endif %}
      - {{ role_regards_stack_logback }}ingest:/config:ro
      - {{ role_regards_stack_workspace_local }}regards/logs/ingest:/logs
      - {{ role_regards_stack_workspace_local }}regards/plugins/ingest:/plugins
      - {{ role_regards_stack_workspace_network }}regards/input:/input
      - {{ role_regards_stack_workspace_network }}regards/workspace:/tmp/workspace
      - type: tmpfs
        target: /tmp
    logging:
      options:
        max-size: "10m"
        max-file: "10"
{% endif %}
        
{% if role_regards_stack_mservices.dataprovider is defined %}
  rs-dataprovider:
    image: {{ role_regards_stack_registry }}/rs-dataprovider:{{ role_regards_stack_mservices.dataprovider.tag }}
    user: "{{ role_regards_stack_container_run_uid }}:{{ role_regards_stack_container_run_gid }}"
    hostname: rs-dataprovider
    read_only: true
    deploy:
      replicas: {{ role_regards_stack_mservices.dataprovider.replicas | default(1) }}
{% if role_regards_stack_mservices.dataprovider.node_label_placement_constraint is defined %}
      placement:
        constraints:
          - node.labels.{{ role_regards_stack_mservices.dataprovider.node_label_placement_constraint.key }} == {{ role_regards_stack_mservices.dataprovider.node_label_placement_constraint.value }}
{% endif %}
    networks:
      - {{ role_regards_stack_docker_network_name }}
{% if role_regards_stack_mservices.dataprovider.jdwp is defined %}
    environment: 
      - ACTIVE_DEBUG=true
{% endif %}
{% if role_regards_stack_mservices.dataprovider.yourkit is defined %}
      - ACTIVE_YOURKIT=true
{% endif %}
{% if role_regards_stack_mservices.dataprovider.http is defined or role_regards_stack_mservices.dataprovider.jdwp is defined or role_regards_stack_mservices.dataprovider.jmx is defined or role_regards_stack_mservices.dataprovider.yourkit is defined %}
    ports:
{% if role_regards_stack_mservices.dataprovider.http is defined %}
      - "{{ role_regards_stack_mservices.dataprovider.http }}:9045"
{% endif %}
{% if role_regards_stack_mservices.dataprovider.jdwp is defined %}
      - "{{ role_regards_stack_mservices.dataprovider.jdwp }}:10500"
{% endif %}
{% if role_regards_stack_mservices.dataprovider.jmx is defined %}
      - "{{ role_regards_stack_mservices.dataprovider.jmx }}:18045"
{% endif %}
{% if role_regards_stack_mservices.dataprovider.yourkit is defined %}
      - "{{ role_regards_stack_mservices.dataprovider.yourkit }}:10001"
{% endif %}
{% endif %}
    volumes:
{% if role_regards_stack_mservices.dataprovider.volumes is defined %}
{% for volume in role_regards_stack_mservices.dataprovider.volumes %}
      - {{ volume.source }}:{{ volume.destination }}
{% endfor %}
{% endif %}
      - {{ role_regards_stack_logback }}dataprovider:/config:ro
      - {{ role_regards_stack_workspace_local }}regards/logs/dataprovider:/logs
      - {{ role_regards_stack_workspace_local }}regards/plugins/dataprovider:/plugins
      - {{ role_regards_stack_workspace_network }}regards/input:/input
      - {{ role_regards_stack_workspace_network }}regards/workspace:/tmp/workspace
      - type: tmpfs
        target: /tmp
    logging:
      options:
        max-size: "10m"
        max-file: "10"
{% endif %}

{% if role_regards_stack_mservices.worker_manager is defined %}
  rs-worker-manager:
    image: {{ role_regards_stack_registry }}/rs-worker-manager:{{ role_regards_stack_mservices.worker_manager.tag }}
    user: "{{ role_regards_stack_container_run_uid }}:{{ role_regards_stack_container_run_gid }}"
    hostname: rs-worker-manager
    read_only: true
    deploy:
      replicas: {{ role_regards_stack_mservices.worker_manager.replicas | default(1) }}
{% if role_regards_stack_mservices.worker_manager.node_label_placement_constraint is defined %}
      placement:
        constraints:
          - node.labels.{{ role_regards_stack_mservices.worker_manager.node_label_placement_constraint.key }} == {{ role_regards_stack_mservices.worker_manager.node_label_placement_constraint.value }}
{% endif %}
    networks:
      - {{ role_regards_stack_docker_network_name }}
{% if role_regards_stack_mservices.worker_manager.jdwp is defined %}
    environment: 
      - ACTIVE_DEBUG=true
{% endif %}
{% if role_regards_stack_mservices.worker_manager.yourkit is defined %}
      - ACTIVE_YOURKIT=true
{% endif %}
{% if role_regards_stack_mservices.worker_manager.http is defined or role_regards_stack_mservices.worker_manager.jdwp is defined or role_regards_stack_mservices.worker_manager.jmx is defined or role_regards_stack_mservices.worker_manager.yourkit is defined %}
    ports:
{% if role_regards_stack_mservices.worker_manager.http is defined %}
      - "{{ role_regards_stack_mservices.worker_manager.http }}:9047"
{% endif %}
{% if role_regards_stack_mservices.worker_manager.jdwp is defined %}
      - "{{ role_regards_stack_mservices.worker_manager.jdwp }}:10500"
{% endif %}
{% if role_regards_stack_mservices.worker_manager.jmx is defined %}
      - "{{ role_regards_stack_mservices.worker_manager.jmx }}:18047"
{% endif %}
{% if role_regards_stack_mservices.worker_manager.yourkit is defined %}
      - "{{ role_regards_stack_mservices.worker_manager.yourkit }}:10001"
{% endif %}
{% endif %}
    volumes:
{% if role_regards_stack_mservices.worker_manager.volumes is defined %}
{% for volume in role_regards_stack_mservices.worker_manager.volumes %}
      - {{ volume.source }}:{{ volume.destination }}
{% endfor %}
{% endif %}
      - {{ role_regards_stack_logback }}worker-manager:/config:ro
      - {{ role_regards_stack_workspace_local }}regards/logs/worker-manager:/logs
      - type: tmpfs
        target: /tmp
    logging:
      options:
        max-size: "10m"
        max-file: "10"
{% endif %}

networks:
  {{ role_regards_stack_docker_network_name }}:
    external: true
    name: {{ role_regards_stack_docker_network_name }}
