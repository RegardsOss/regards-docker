#
# Copyright 2018-2020, CS GROUP â€“ France, http://www.c-s.fr
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#
---
- name: Generate servers certificates
  command: |
    {{ role_path }}/../../tools/generate-self-signed-certificate.sh
    -f '{{ hostvars[item]['ansible_host'] }}'
    -e '{{ hostvars[item]['certificates_email'] }}'
    {% if 'alternative_dns_names' in hostvars[item] %}
    -d '{{ hostvars[item]['alternative_dns_names'] }}'
    {% endif %}
    {% if 'alternative_ip_names' in hostvars[item] %}
    -p '{{ hostvars[item]['alternative_ip_names'] }}'
    {% endif %}
    {% if 'openssl_cnf_path' in hostvars[item] %}
    -o '{{ hostvars[item]['openssl_cnf_path'] }}'
    {% endif %}
  loop: "{{ groups[hostvars[inventory_hostname]['gen_certificates_group_name']] }}"

- name: Generate client certificate
  command: "{{ role_path }}/../../tools/generate-client-certificate.sh"
